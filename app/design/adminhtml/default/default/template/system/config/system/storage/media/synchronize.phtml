<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_default
 * @copyright   Copyright (c) 2010 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>

<?php /* var $this Mage_Adminhtml_Block_System_Config_System_Storage_Media_Synchronize */ ?>

<script type="text/javascript">
    defaultValues = [];
    defaultValues['system_media_storage_configuration_media_storage'] = $('system_media_storage_configuration_media_storage').value;
    defaultValues['system_media_storage_configuration_media_database'] = $('system_media_storage_configuration_media_database').value;


    Event.observe(window, 'load', function(){
        $('synchronize_button').addClassName('disabled');
        checkStatus();
    });
    $('system_media_storage_configuration_media_storage').observe('change', enableButton);
    $('system_media_storage_configuration_media_database').observe('change', enableButton);

    function enableButton(event) {
        var element = Event.element(event);
        if (element.value != defaultValues[element.id]) {
            $('synchronize_button').removeClassName('disabled');
        } else {
            $('synchronize_button').addClassName('disabled');
        }
    }

    function checkStatus() {
        u = new Ajax.PeriodicalUpdater('', '<?php echo $this->getAjaxStatusUpdateUrl() ?>', {
            method: 'get',
            frequency: 5,
            loaderArea: false,
            onSuccess: function(transport) {
                try {
                    response = eval('(' + transport.responseText + ')');
                } catch (e) {
                    response = {};
                }

                if (response.state == '1') {
                    if (response.message) {
                        if ($('sync_span').hasClassName('no-display')) {
                            $('sync_span').removeClassName('no-display');
                            $('sync_message_span').update(response.message);
                        }
                    }
                } else {
                    u.stop();
                    $('sync_span').addClassName('no-display');
                }
            }
        });
    }

    function synchronize() {
        params = {
            storage:    $('system_media_storage_configuration_media_storage').value,
            connection: $('system_media_storage_configuration_media_database').value
        }

        new Ajax.Request('<?php echo $this->getAjaxSyncUrl() ?>', {
            parameters: params,
            loaderArea: false,
            asynchronous: true
        });

        window.setTimeout('checkStatus()', 2011);

        $('synchronize_button').addClassName('disabled');
    }
</script>

<?php echo $this->getButtonHtml() ?><span class="sync-indicator no-display" id="sync_span"><img alt="Synchronize" src="<?php echo $this->getSkinUrl('images/process_spinner.gif') ?>"/><span id="sync_message_span"></span></span>
